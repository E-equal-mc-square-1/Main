--// Script Agent Key System (Full + Minimize + 3h CD + Fixed Hearts + HH+MM Key) by Charlotte 💕 for Daddy
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local GuiService = game:GetService("GuiService")

-- ▼ Settings ▼ --
local getKeyLink = "https://kilometres.netlify.app/99NightsInTheForest1/getkey1"
local scriptToRun = [[loadstring(game:HttpGet("https://raw.githubusercontent.com/VapeVoidware/VW-Add/main/nightsintheforest.lua", true))()]]

-- ▼ Utility: Base64 Encode ▼ --
local b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
local function base64enc(data)
	return ((data:gsub('.', function(x)
		local r,bits='',x:byte()
		for i=8,1,-1 do r=r..(bits%2^i-bits%2^(i-1)>0 and '1' or '0') end
		return r
	end)..'0000'):gsub('%d%d%d?%d?%d?%d?', function(x)
		if (#x < 6) then return '' end
		local c=0
		for i=1,6 do c=c+(x:sub(i,i)=='1' and 2^(6-i) or 0) end
		return b:sub(c+1,c+1)
	end)..({ '', '==', '=' })[#data%3+1])
end

-- ▼ Daily Key Generator (with HH+MM) ▼ --
local function getDailyKey()
	local d = os.date("*t")
	local DD,MM,YYYY = d.day,d.month,d.year
	local HH,MIN = d.hour,d.min
	-- now includes hours + minutes in the number
	local num = (DD+MM+YYYY+HH+MIN)*7
	local raw = "99nightsintheforest"..num.."Kilometres"
	return base64enc(raw)
end

-- create variable and auto-refresh it every minute
local correctKey = getDailyKey()
task.spawn(function()
	while true do
		correctKey = getDailyKey()
		task.wait(60) -- refresh every 60 seconds
	end
end)

-- ▼ Player Storage (3h key timestamp) ▼ --
local playerGui = LocalPlayer:WaitForChild("PlayerGui")
local lastUsedKey = playerGui:FindFirstChild("KeySystemLastUsed")
if not lastUsedKey then
	lastUsedKey = Instance.new("NumberValue")
	lastUsedKey.Name = "KeySystemLastUsed"
	lastUsedKey.Value = 0
	lastUsedKey.Parent = playerGui
end

-- ▼ 3h cooldown check ▼ --
local now = os.time()
local cdSeconds = 3*3600 -- 3 hours
local elapsed = now - lastUsedKey.Value
local onCooldown = elapsed < cdSeconds
local remainingCD = math.max(0, cdSeconds - elapsed)

-- ▼ Countdown GUI (persistent) ▼ --
local countdownGui = Instance.new("ScreenGui")
countdownGui.Name = "CountdownGui"
countdownGui.Parent = playerGui
countdownGui.ResetOnSpawn = false

local countdownLabel = Instance.new("TextLabel")
countdownLabel.Size = UDim2.new(0,180,0,25)
countdownLabel.AnchorPoint = Vector2.new(1,1)
countdownLabel.Position = UDim2.new(1,-10,1,-10)
countdownLabel.BackgroundTransparency = 1
countdownLabel.TextColor3 = Color3.fromRGB(0,0,0)
countdownLabel.Font = Enum.Font.Gotham
countdownLabel.TextSize = 14
countdownLabel.TextXAlignment = Enum.TextXAlignment.Right
countdownLabel.Parent = countdownGui

task.spawn(function()
	while countdownLabel.Parent do
		local now = os.time()
		local remaining = math.max(0, cdSeconds - (now - lastUsedKey.Value))
		local h = math.floor(remaining/3600)
		local m = math.floor((remaining%3600)/60)
		local s = remaining%60
		countdownLabel.Text = string.format("Next Key in %02d:%02d:%02d",h,m,s)
		task.wait(1)
	end
end)

-- ▼ Key UI ▼ --
local gui = Instance.new("ScreenGui")
gui.Name = "ScriptAgentKeyUI"
gui.Parent = playerGui
gui.ResetOnSpawn = false

local minimised = false

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 380, 0, 220)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(30, 0, 60)
frame.BorderSizePixel = 2
frame.BorderColor3 = Color3.fromRGB(128,0,255)
frame.ClipsDescendants = true
frame.Active = true
frame.Draggable = true
frame.Parent = gui
Instance.new("UICorner",frame).CornerRadius = UDim.new(0,12)

-- Falling hearts background
local heartsFolder = Instance.new("Folder", frame)
heartsFolder.Name = "Hearts"
task.spawn(function()
	while gui and gui.Parent do
		local heart = Instance.new("TextLabel")
		heart.Text = "💜"
		heart.TextScaled = true
		heart.BackgroundTransparency = 1
		heart.Size = UDim2.new(0,30,0,30)
		heart.Position = UDim2.new(math.random(), -15, -0.1, 0)
		heart.TextColor3 = Color3.fromRGB(255,0,255)
		heart.ZIndex = 0
		heart.Parent = heartsFolder
		task.spawn(function()
			for i=1,80 do
				heart.Position = heart.Position + UDim2.new(0,0,0.02,0)
				task.wait(0.03)
			end
			heart:Destroy()
		end)
		task.wait(math.random(5,15)/10)
	end
end)

-- Title
local title = Instance.new("TextLabel")
title.Text = "Script Agent Key System"
title.Size = UDim2.new(1,0,0,30)
title.Position = UDim2.new(0,0,0,5)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255,255,255)
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.Parent = frame

-- TextBox & Status
local textbox = Instance.new("TextBox")
textbox.PlaceholderText = "Enter Key Here"
textbox.Size = UDim2.new(0.85,0,0,35)
textbox.Position = UDim2.new(0.075,0,0.3,0)
textbox.BackgroundColor3 = Color3.fromRGB(60,0,90)
textbox.TextColor3 = Color3.new(1,1,1)
textbox.Font = Enum.Font.Gotham
textbox.TextSize = 18
textbox.Parent = frame
Instance.new("UICorner",textbox).CornerRadius = UDim.new(0,8)

local status = Instance.new("TextLabel")
status.Text = ""
status.Size = UDim2.new(1,0,0,20)
status.Position = UDim2.new(0,0,0.55,0)
status.BackgroundTransparency = 1
status.TextColor3 = Color3.fromRGB(255,255,255)
status.TextScaled = true
status.Parent = frame

-- Buttons
local checkBtn = Instance.new("TextButton")
checkBtn.Text = "Check Key"
checkBtn.Size = UDim2.new(0.42,0,0,40)
checkBtn.Position = UDim2.new(0.05,0,0.7,0)
checkBtn.BackgroundColor3 = Color3.fromRGB(255,0,255)
checkBtn.TextColor3 = Color3.new(1,1,1)
checkBtn.Font = Enum.Font.GothamBold
checkBtn.TextSize = 18
checkBtn.Parent = frame
Instance.new("UICorner",checkBtn).CornerRadius = UDim.new(0,10)

local getKey = Instance.new("TextButton")
getKey.Text = "Get Key"
getKey.Size = UDim2.new(0.42,0,0,40)
getKey.Position = UDim2.new(0.53,0,0.7,0)
getKey.BackgroundColor3 = Color3.fromRGB(0,0,0)
getKey.TextColor3 = Color3.new(1,1,1)
getKey.Font = Enum.Font.GothamBold
getKey.TextSize = 18
getKey.Parent = frame
Instance.new("UICorner",getKey).CornerRadius = UDim.new(0,10)

-- Minimize
local closeBtn = Instance.new("TextButton")
closeBtn.Text = "-"
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.AnchorPoint = Vector2.new(0,0)
closeBtn.BackgroundColor3 = Color3.fromRGB(255,0,0)
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 24
closeBtn.Parent = frame
Instance.new("UICorner",closeBtn).CornerRadius = UDim.new(0,5)

closeBtn.MouseButton1Click:Connect(function()
	frame.Visible = false
	minimised = true
end)

GuiService.MenuClosed:Connect(function()
	if minimised then
		frame.Visible = true
		minimised = false
	end
end)

-- Disco effect
task.spawn(function()
	local colors = {
		Color3.fromRGB(255,0,255),
		Color3.fromRGB(0,255,255),
		Color3.fromRGB(255,255,0),
		Color3.fromRGB(0,255,0),
	}
	local idx = 1
	while checkBtn and checkBtn.Parent do
		checkBtn.BackgroundColor3 = colors[idx]
		idx = idx % #colors + 1
		task.wait(0.3)
	end
end)

task.spawn(function()
	while getKey and getKey.Parent do
		getKey.BackgroundColor3 = Color3.fromRGB(0,0,0)
		task.wait(0.4)
		getKey.BackgroundColor3 = Color3.fromRGB(255,255,255)
		getKey.TextColor3 = Color3.fromRGB(0,0,0)
		task.wait(0.4)
		getKey.TextColor3 = Color3.fromRGB(255,255,255)
	end
end)

-- Buttons logic
getKey.MouseButton1Click:Connect(function()
	setclipboard(getKeyLink)
	status.Text = "Key link copied!"
	status.TextColor3 = Color3.fromRGB(255,255,0)
end)

checkBtn.MouseButton1Click:Connect(function()
	if onCooldown then
		status.Text = "⏳ Wait for cooldown!"
		status.TextColor3 = Color3.fromRGB(255,255,0)
		return
	end

	if textbox.Text == correctKey then
		status.Text = "✅ Correct Key!"
		status.TextColor3 = Color3.fromRGB(0,255,0)

		-- start 3h cooldown
		lastUsedKey.Value = os.time()
		onCooldown = true

		task.wait(0.3)
		frame:Destroy()

		local thanks = Instance.new("TextLabel")
		thanks.Text = "💜 Thanks 💜"
		thanks.Size = UDim2.new(1,0,1,0)
		thanks.BackgroundTransparency = 1
		thanks.TextScaled = true
		thanks.TextColor3 = Color3.fromRGB(255,0,255)
		thanks.Parent = gui
		task.wait(2)
		gui:Destroy()

		loadstring(scriptToRun)()
	else
		status.Text = "❌ Wrong Key"
		status.TextColor3 = Color3.fromRGB(255,0,0)
	end
end)
